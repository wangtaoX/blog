<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>å¥”è·‘çš„èš‚èš</title>
 <link href="http://wangtaox.github.io/atom.xml" rel="self"/>
 <link href="http://wangtaox.github.io"/>
 <updated>2016-07-27T16:02:29+08:00</updated>
 <id>http://wangtaox.github.io/</id>
 <author>
   <name>TaoWang</name>
 </author>

 
 <entry>
   <title>&quot;CSS secrets&quot; Reading Notes</title>
   <link href="http://wangtaox.github.io/2016/05/14/css-secret-reading-notes.html"/>
   <updated>2016-05-14T00:00:00+08:00</updated>
   <id>http://wangtaox.github.io/2016/05/14/css-secret-reading-notes</id>
   <content type="html">&lt;h3&gt;currentColor&lt;/h3&gt;

&lt;p&gt;In css3, we got a special new color keyword &lt;strong&gt;currentColor&lt;/strong&gt;, which always resolves to the value of the &lt;strong&gt;color&lt;/strong&gt; property, make it &lt;strong&gt;the first ever variable&lt;/strong&gt; in css.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;CSS&quot;&gt;.dont-do-this {
  height: 2em;
  width: 1em;
  background: currentColor;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It will become even more useful when we get functions to manipulate colors in native css.&lt;/p&gt;

&lt;h3&gt;Use shorthands wisely&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;CSS&quot;&gt;.positive-bg {
  background: blue;
  /*background-color: blue;*/
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It is good defensive coding and future-proofing to use them, unless we intentionally want to use cascaded properties.&lt;/p&gt;

&lt;h3&gt;background-clip&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;CSS&quot;&gt;.photo-box {
  border: .4em solid rgba(255, 255, 255, .5);
  border-radius: .4em;
  font-size: 120%;
  line-height: 1.5;
  width: 720px;
  background: rgba(255, 255, 255);
  background-clip: padding-box;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;outline&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;outline&lt;/strong&gt; do not fellow the elementsâ€™s rounding but &lt;strong&gt;box-shadow&lt;/strong&gt; do&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;css&quot;&gt;.box {
  background: blue;
  border-radius: .8em;
  padding: 1em;
  box-shadow: 0 0 0 .8em red;
  outline: .8em solid red;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;linear-gradient&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;css&quot;&gt;.bg {
  background: linear-gradient(red 20%, blue 80%);
  ....
  /* 80% ï¼ 20% is the length of gradient area */
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we set the color position at 0, it means its position is set to where the previous one stop.&lt;/p&gt;

&lt;h3&gt;box-shadow&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;css&quot;&gt;.box {
  box-shadow: 0 0 10px blue;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;z-index&lt;/h3&gt;

&lt;p&gt;First of all, z-index only works on positioned elements. If you try to set a z-index on an element with no position specified, it will do nothing. Secondly, z-index values can create stacking contexts.&lt;/p&gt;

&lt;p&gt;Every stacking context has a single HTML element as its root element. When a new stacking context is formed on an element, that stacking context confines all of its child elements to a particular place in the stacking order, That means that if an element is contained in a stacking context at the bottom of the stacking order, there is no way to get it to appear in front of another element in a different stacking context that is higher in the stacking order, even with a z-index of a billion!&lt;/p&gt;

&lt;p&gt;New stacking contexts can be formed on an element in one of three ways:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;When an element is the root element of a document (the &lt;strong&gt;html&lt;/strong&gt; element)&lt;/li&gt;
&lt;li&gt;When an element has a position value other than static and a z-index value other than auto&lt;/li&gt;
&lt;li&gt;When an element has an opacity value less than 1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In addition to opacity, several newer CSS properties also create stacking contexts. These include: transforms, filters, css-regions, paged media, and possibly others. As a general rule, it seems that if a CSS property requires rendering in an offscreen context, it must create a new stacking context.&lt;/p&gt;

&lt;p&gt;Here are the basic rules to determine stacking order within a single stacking context (from back to front):&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;The stacking contextâ€™s root element&lt;/li&gt;
&lt;li&gt;Positioned elements (and their children) with negative z-index values (higher values are stacked in front of lower values; elements with the same value are stacked according to appearance in the HTML)&lt;/li&gt;
&lt;li&gt;Non-positioned elements (ordered by appearance in the HTML)&lt;/li&gt;
&lt;li&gt;Positioned elements (and their children) with a z-index value of auto (ordered by appearance in the HTML)&lt;/li&gt;
&lt;li&gt;Positioned elements (and their children) with positive z-index values (higher values are stacked in front of lower values; elements with the same value are stacked according to appearance in the HTML)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note: positioned elements with negative z-indexes are ordered first within a stacking context, which means they appear behind all other elements. Because of this, it becomes possible for an element to appear behind its own parent, which is normally not possible. This will only work if the elementâ€™s parent is in the same stacking context and is not the root element of that stacking context.&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>&quot;flip&quot;åŠ¨ç”»</title>
   <link href="http://wangtaox.github.io/2016/03/28/flip.html"/>
   <updated>2016-03-28T00:00:00+08:00</updated>
   <id>http://wangtaox.github.io/2016/03/28/flip</id>
   <content type="html">&lt;h3&gt;flipåŠ¨ç”»&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;first: å…ƒç´ åœ¨åŠ¨ç”»ä¸­çš„åˆå§‹çŠ¶æ€&lt;/li&gt;
&lt;li&gt;last: å…ƒç´ çš„åŠ¨ç”»çš„ç»“æŸçŠ¶æ€&lt;/li&gt;
&lt;li&gt;invert: è®¡ç®—firstå’ŒlastçŠ¶æ€çš„å·®å€¼ï¼Œç„¶åè®¾ç½®ç›¸åº”çš„å±æ€§(transform, opacityç­‰)ï¼Œä½¿å…ƒç´ åœ¨åˆå§‹çŠ¶æ€ã€‚&lt;/li&gt;
&lt;li&gt;play: è§¦å‘æ•´ä¸ªåŠ¨ç”»&lt;/li&gt;
&lt;/ol&gt;


&lt;h4&gt;ä¸€ä¸ªä¾‹å­ğŸŒ°&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&quot;html&quot;&gt;&amp;lt;head&amp;gt;
  &amp;lt;style media=&quot;screen&quot;&amp;gt;
    body {
    }

    .container {
      width: 100%;
      height: 100%;
      margin: 0 auto;
      background: #BBDEFB;
      position: relative;
    }

    .circle {
      width: 100px;
      height: 100px;
      border-radius: 100%;
      background-color: #E1BEE7;
      position: absolute;
      top: 10px;
      left: 10px;
    }

    .circle-end {
      top: auto;
      left: auto;
      bottom: 10px;
      right: 10px;
    }

  &amp;lt;/style&amp;gt;
&amp;lt;/head&amp;gt;

&amp;lt;body&amp;gt;
  &amp;lt;button type=&quot;button&quot; name=&quot;button&quot; onclick=&quot;doAnimate()&quot;&amp;gt;Animate&amp;lt;/button&amp;gt;
  &amp;lt;div class=&quot;container&quot;&amp;gt;
    &amp;lt;div class=&quot;circle&quot;&amp;gt;
    &amp;lt;/div&amp;gt;
  &amp;lt;/div&amp;gt;
  &amp;lt;script type=&quot;text/javascript&quot;&amp;gt;
  function doAnimate() {
    var node = document.getElementsByClassName(&#39;circle&#39;)[0]

    //è®¡ç®—åˆå§‹å±æ€§
    var first = node.getBoundingClientRect()
    node.classList.add(&#39;circle-end&#39;)
    //è®¡ç®—ç»“æŸå±æ€§
    var last = node.getBoundingClientRect()

    //invert
    var invertX = first.left - last.left
    var invertY = first.top - last.top

    node.style.transform = &#39;translate(&#39; + invertX + &#39;px,&#39; + invertY + &#39;px)&#39;
    node.style.transition = &#39;transform 0s&#39;

    requestAnimationFrame(function(node) {
      return function() {

        //è§¦å‘åŠ¨ç”»
        node.style.transition = &#39;all 1s&#39;;
        node.style.transform  = &#39;&#39;;
        console.log(node)
      }
    }(node))
  }

  &amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;requestAnimationFrameå‡½æ•°&lt;/h4&gt;

&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame&quot;&gt;requestAnimationFrame&lt;/a&gt;å‡½æ•°ä¸»è¦å‘Šè¯‰æµè§ˆå™¨åœ¨é‡ç»˜æ¯ä¸€å¸§åŠ¨ç”»æ—¶ï¼Œå¯ä»¥è¿è¡Œç”¨æˆ·å®šä¹‰çš„ä»£ç ï¼Œå¯ä»¥è¿›è¡Œç›¸åº”çš„è®¡ç®—ç­‰ç­‰ã€‚&lt;/p&gt;

&lt;h4&gt;å‚è€ƒèµ„æ–™&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://medium.com/developers-writing/animating-the-unanimatable-1346a5aab3cd#.86itpf3ga&quot;&gt;Animating the Unanimatable.&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://aerotwist.com/blog/flip-your-animations/&quot;&gt;FLIP Your Animations&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

</content>
 </entry>
 
 <entry>
   <title>ç†è§£javascript promise</title>
   <link href="http://wangtaox.github.io/2016/03/04/promise.html"/>
   <updated>2016-03-04T00:00:00+08:00</updated>
   <id>http://wangtaox.github.io/2016/03/04/promise</id>
   <content type="html">&lt;h3&gt;so promise ï¼Ÿ&lt;/h3&gt;

&lt;p&gt;promiseï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯æ‰¿è¯ºçš„æ„æ€ï¼Œåœ¨javascriptä¸­ï¼Œpromiseæ˜¯ä¸€ä¸ªå…³äºå¼‚æ­¥æ“ä½œçš„ç»“æœçš„â€œæ‰¿è¯ºâ€,
å¯ä»¥åœ¨&lt;a href=&quot;https://promisesaplus.com/&quot;&gt;promise A+ spec&lt;/a&gt;ä¸­äº†è§£æ›´å¤šå…³äºpromiseçš„ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨æ­¤ç¿»è¯‘äº†pouchdbä¸­å…³äºpromiseçš„åšå®¢ï¼Œä»¥åŠ æ·±å¯¹promiseçš„ç†è§£ã€‚&lt;a href=&quot;https://twitter.com/nolanlawson&quot;&gt;ä½œè€…&lt;/a&gt;åœ¨æ¨ä¸Šå‘äº†ä¸€æ®µå…³äºpromiseçš„ä»£ç ï¼Œå¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;//case 1
doSomething().then(function() {
    return doSomethingElse()
})
//case 2
doSomething().then(function() {
    doSomethingElse()
})
//case 3
doSomething().then(doSomethingElse())
//case 4
doSomething().then(doSomethingElse)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ³¨æ„: &lt;code&gt;doSomething&lt;/code&gt;åŠ&lt;code&gt;doSomethingElse&lt;/code&gt;éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°å¹¶è¿”å›æ–°çš„promise.&lt;/p&gt;

&lt;p&gt;çŸ¥é“å‡ ä¸ªcaseçš„åŒºåˆ«ä¹ˆ? #@!...ä»¥ä¸‹ä»£ç å¯èƒ½ä¼šä½¿ç”¨ä¸€äº›ES6è¯­æ³•ã€‚&lt;/p&gt;

&lt;h3&gt;å‘1: å›è°ƒé‡‘å­—å¡”&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;getUsersFromRESTAPI().then((resultOfUsers) =&amp;gt; {
    resultOfUsers.forEach((user) =&amp;gt; {
        localStorageWithPromise.put(user).then(() =&amp;gt; {
            console.log(`put user ${user.name} to localStorage success!`)
        }).catch((err) =&amp;gt; {
            console.log(`put user ${user.name} to localStorage failed!`)
            localStorageWithPromise.remove(user.id).then(() =&amp;gt; {
                console.log(`remove possible user info with user id : ${user.id}`)
            })
            ...
        })
    })
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å½“æˆ‘ä»¬éœ€è¦å®Œæˆæ›´å¤æ‚çš„ä¸€äº›å›è°ƒæ“ä½œæ—¶ï¼Œå¯èƒ½ä»£ç æ¯”è¿™è¿˜åµŒå¥—å¾—æ·±ï¼Œè¿™æ ·ä»£ç çš„å¯è¯»æ€§ä»¥åŠå¯ç»´æŠ¤æ€§å°±ä¼šå¾ˆç³Ÿç³•ï¼Œè€Œæ›´å¥½çš„ä¹¦å†™
æ–¹å¼åº”è¯¥è¿™æ ·ï¼Œç§°ä¸º&lt;code&gt;ç»„åˆpromise&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;getUsersFromRESTAPI().then(resultOfUsers =&amp;gt; {
    return Promise.all(resultOfUsers.forEach((user) =&amp;gt; {
        return localStorageWithPromise.put(user)
    }))
}).then((resultInfo) =&amp;gt; {
    console.log(`put result ${resultInfo}`)
}).catch((err) =&amp;gt; {
    console.log(err)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ›´ç›´è§‚ä¸€ç‚¹ï¼Œæˆ–è®¸æˆ‘ä»¬åº”è¯¥ç»„ç»‡æˆ‘ä»¬çš„promiseè°ƒç”¨é“¾å¦‚ä¸‹é¢è¿™æ ·çš„æ–¹å¼ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;operationA().then((resultOfA) =&amp;gt; {
    return doWithResultA(resultOfA)
}).then((resultFromA) =&amp;gt; {
    return operationB(resultFromA)
}).then((resultFromB) =&amp;gt; {
    return operationC(resultFromB)
}).catch(err =&amp;gt; {
    console.log(`any errors &quot;${err}&quot; happened in promise chain`)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·æ•´ä¸ªè°ƒç”¨é“¾ä¼šæ¯”è¾ƒæ¸…æ™°ï¼Œä¸”å¯ä»¥ç»Ÿä¸€çš„&lt;code&gt;catch&lt;/code&gt;é”™è¯¯å¹¶å¤„ç†ã€‚&lt;/p&gt;

&lt;h3&gt;å‘2: forEachä¸promise&lt;/h3&gt;

&lt;p&gt;æ¯”å¦‚å¦‚ä¸‹çš„æ“ä½œ:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;getUsersFromRESTAPI().then(resultOfUsers =&amp;gt; {
    resultOfUsers.forEach(user =&amp;gt; {
        user.remove()
    })
}).then(() =&amp;gt; {
    //ä»¥ä¸ºå·²ç»åˆ é™¤äº†æ‰€æœ‰ç”¨æˆ·
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä»¥ä¸ºè¿™æ ·å†™å°±å¯ä»¥äº†ï¼Œå…¶å®æ˜¯é”™è¯¯çš„ï¼Œç¬¬äºŒä¸ªthenå›è°ƒå¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰userè¢«åˆ é™¤æ‰æ‰§è¡Œï¼Œå› ä¸ºåœ¨ç¬¬ä¸€ä¸ªthenå›è°ƒä¸­ï¼Œå‡½æ•°è¿”å›
çš„æ˜¯&lt;code&gt;undefined&lt;/code&gt;, æ‰€ä»¥è¿™æ ·çš„å†™æ³•å°±ä¼šå­˜åœ¨bug, æ­£ç¡®çš„å†™æ³•åº”è¯¥å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;getUsersFromRESTAPI().then(resultOfUsers =&amp;gt; {
    return Promise.all(resultOfUsers.forEach(user =&amp;gt; {
        return user.remove()
    }))
}).then(() =&amp;gt; {
    console.log(&quot;all users has been deleted.&quot;)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ç¬¬ä¸€ä¸ªthenå›è°ƒä¸­è¿”å›äº†promiseï¼Œå¹¶ä½¿ç”¨äº†&lt;code&gt;promise.all&lt;/code&gt;, æ³¨æ„&lt;code&gt;user.remove&lt;/code&gt;ä¹Ÿæ˜¯è¿”å›promiseçš„ã€‚&lt;/p&gt;

&lt;h3&gt;å‘3: å¿˜è®°catché”™è¯¯&lt;/h3&gt;

&lt;p&gt;æˆ‘ä»¬ä¸åº”è¯¥å»å‡è®¾æˆ‘ä»¬çš„promiseä¸è¿”å›ä»»ä½•é”™è¯¯ï¼Œåº”è¯¥åœ¨promiseè°ƒç”¨ä¸­éƒ½è¿›è¡Œæ­£ç¡®çš„é”™è¯¯å¤„ç†.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;promise1().then(() =&amp;gt; {
    return opReturnPromise2()
}).then(() =&amp;gt; {
    return opReturnPromise3()
}).catch(err =&amp;gt; {
    //handle errors properly.
})
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;promiseä¸­çš„è¿”å›å€¼&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;promise1().then(() =&amp;gt; {
    opReturnPromise2()
}).then(() =&amp;gt; {
    opReturnPromise3()
}).catch(err =&amp;gt; {
    //handle errors properly.
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ‰ä»€ä¹ˆé—®é¢˜ä¹ˆï¼Ÿè¿™å„¿åœ¨promiseçš„å›è°ƒä¸­&lt;code&gt;è¿”å›å€¼å­˜åœ¨é—®é¢˜&lt;/code&gt;, åœ¨promiseä¸­ï¼Œthen()å›è°ƒå¯ä»¥è¿”å›:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;è¿”å›å¦ä¸€ä¸ªpromise.&lt;/li&gt;
&lt;li&gt;è¿”å›ä¸€ä¸ªå€¼(æˆ–è€…undefined).&lt;/li&gt;
&lt;li&gt;è¿”å›ä¸€ä¸ªé”™è¯¯.&lt;/li&gt;
&lt;/ol&gt;


&lt;h4&gt;è¿”å›å¦ä¸€ä¸ªpromise&lt;/h4&gt;

&lt;p&gt;è¿™å°±æ˜¯ä¸Šé¢æåˆ°çš„&lt;code&gt;ç»„åˆpromise&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;promise1().then(() =&amp;gt; {
    return opReturnPromise2()
}).then(() =&amp;gt; {
    return opReturnPromise3()
}).catch(err =&amp;gt; {
    //handle errors properly.
})
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;è¿”å›ä¸€ä¸ªå€¼(æˆ–è€…undefined)&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;getUserFromRESTAPI(userName).then((userInfo) =&amp;gt; {
    if (FriendsCache[userInfo.id]) {
        return FriendsCache[userInfo.id]
    }
    return getUserFriends(userInfo.id)
}).then((friends) =&amp;gt; {
    console.log(friends)
}).catch(err =&amp;gt; {
    console.log(err)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å†™æ˜¯ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œåœ¨ç¬¬äºŒä¸ªå¤„ç†friendsçš„thenå›è°ƒä¸­ï¼Œæˆ‘ä¸éœ€è¦å…³å¿ƒfriendsæ˜¯åœ¨cacheä¸­è¿˜æ˜¯ä»APIä¸­è·å–çš„ï¼Œå¤„ç†å¾—åˆ°çš„å¥½å‹åˆ—è¡¨å³å¯ã€‚
ç”±äºåœ¨javascriptä¸­ï¼Œå‡½æ•°ä¸æ˜¾è§†çš„è¿”å›ä»»ä½•å€¼ï¼Œåˆ™è¿”å›undefinedï¼Œæ‰€æœ‰åœ¨promiseçš„thenå›è°ƒä¸­ï¼Œå»ºè®®æ€»æ˜¯è¿”å›ä¸€ä¸ªå€¼æˆ–è€…æŠ›å‡ºé”™è¯¯ã€‚&lt;/p&gt;

&lt;h4&gt;è¿”å›ä¸€ä¸ªé”™è¯¯&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;getUserFromRESTAPI(userName).then((userInfo) =&amp;gt; {
    if (isLoggedout(userInfo.id)) {
        throw new Error(&quot;logged out!&quot;)
    }
    if (FriendsCache[userInfo.id]) {
        return FriendsCache[userInfo.id]
    }
    return getUserFriends(userInfo.id)
}).then((friends) =&amp;gt; {
    console.log(friends)
}).catch(err =&amp;gt; {
    console.log(err)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;å·§ç”¨Promose.resolve&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨promiseåŒ…è£…åŒæ­¥çš„ä»£ç ä½¿å…¶å¼‚æ­¥åŒ–ï¼Œå¹¶è¿›è¡Œé”™è¯¯å¤„ç†ã€‚å¯¹äºåŒæ­¥çš„æ“ä½œï¼Œpromiseä¹Ÿå¯ä»¥æä¾›å¾ˆå¤šå¸®åŠ©ï¼Œæ¯”å¦‚:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;let caculateSomethingAndMayThrowError  = (x, y) =&amp;gt; {
    if (x &amp;lt; y) {
        throw new Error(&quot;x &amp;lt; y&quot;)
    }
    return x - y
}

let wrapAPI2Promise = () =&amp;gt; {
    return Promise.resolve().then(() =&amp;gt; {
        let value = caculateSomethingAndMayThrowError()
        return value
    }).then((value) =&amp;gt; {
        console.log(value)
    }).catch((err) =&amp;gt; {
        console.log(err)
    })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨catchä¸­æˆ‘ä»¬å¯ä»¥å¤„ç†åŒæ­¥å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸.&lt;/p&gt;

&lt;h3&gt;é¿å…rejectå‡½æ•°ï¼Œä½¿ç”¨catch&lt;/h3&gt;

&lt;p&gt;catchå‡½æ•°å…¶å®æ˜¯ä¸€ä¸ªè¯­æ³•ç³–, å¦‚ä¸‹æ‰€ç¤º:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;promise1().catch((err) =&amp;gt; {})
//equal to
promise1().then(null, (err) =&amp;gt; {})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½†æ˜¯å¦‚ä¸‹çš„ä»£ç å´å¹¶ä¸ä¸€æ ·ï¼Œå¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;promise1().then(() =&amp;gt; {
    return promise2()
}).catch((err) =&amp;gt; {
    console.log(err)
})

promise1().then(() =&amp;gt; {
    return promise2()
}, (err) =&amp;gt; {
    console.log(err)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¬¬ä¸€ä¸ªcatchä¼šå¤„ç†æ•´ä¸ªpromiseé“¾ä¸­çš„å¼‚å¸¸é”™è¯¯ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå´æ˜¯å¤„ç†promise1çš„å¼‚å¸¸é”™è¯¯ï¼Œå› ä¸ºå®ƒç›¸å½“äºpromise1çš„rejectå‡½æ•°ã€‚
æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹å»ºè®®åªç”¨catchå‡½æ•°ï¼Œé¿å…ç»™thenä¼ é€’ç¬¬äºŒä¸ªå‚æ•°å¯¼è‡´ç†è§£é”™è¯¯ï¼Œå‡ºç°bugã€‚&lt;/p&gt;

&lt;h3&gt;promiseå·¥å‚å‡½æ•°&lt;/h3&gt;

&lt;p&gt;æœ‰æ—¶å¯ä»¥é€šè¿‡å·¥å‚å‡½æ•°ï¼Œç»„åˆæˆ‘ä»¬çš„promiseé“¾ï¼Œä½†æ˜¯ä¸€å®šè¦æ³¨æ„è¿”å›å€¼, ä¾‹å¦‚:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;javascript&quot;&gt;//ä¾æ¬¡sleep 1s

let suspendOneSecondFactory = () =&amp;gt; {
    return () =&amp;gt; {
        return new Promise((resolve, reject) =&amp;gt; {
            setTimeout(() =&amp;gt; {
                console.log(&#39;sleep 1s&#39;)
                resolve()
            }, 1000)
        })
    }
}

let result = Promise.resolve()
[1, 2, 3].forEach(() =&amp;gt; {
    result = result.then(suspendOneSecondFactory())
})
result.then(() =&amp;gt; {
    console.log(&quot;the end&quot;)
}).catch(err =&amp;gt; {
    console.log(err)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;æ€»ç»“&lt;/h3&gt;

&lt;p&gt;promiseåœ¨ä½¿ç”¨æ—¶ä¸€å®šè¦æ³¨æ„thenå›è°ƒçš„è¿”å›å€¼ï¼Œä»¥åŠç»„åˆä½¿ç”¨promiseï¼Œå¹¶å°†æ“ä½œå°½é‡æ­¥éª¤åŒ–ï¼Œé‚£æ ·å¯ä»¥ä½¿ç”¨proiseé“¾ç»„åˆå‡ºå„ç§éœ€è¦çš„
ä¾èµ–é“¾å¹¶è¿›è¡Œè°ƒç”¨, å¦‚æœç»™thenè°ƒç”¨ä¼ é€’éå‡½æ•°å€¼ï¼Œåœ¨thenè°ƒç”¨ä¸­ä¼ é€’çš„éå‡½æ•°å€¼ä¼šè¢«è§£æä¸ºnullã€‚&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>golang grpcå­¦ä¹ </title>
   <link href="http://wangtaox.github.io/2016/02/01/grpc.html"/>
   <updated>2016-02-01T00:00:00+08:00</updated>
   <id>http://wangtaox.github.io/2016/02/01/grpc</id>
   <content type="html">&lt;p&gt;ä½¿ç”¨gRPCæ„å»ºæ–‡ä»¶ä¼ è¾“æœåŠ¡&lt;/p&gt;

&lt;h3&gt;grpcç®€ä»‹&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;http://www.grpc.io/&quot;&gt;grpc&lt;/a&gt;æ˜¯Googleå¼€æºçš„rpcæ¡†æ¶ï¼Œä½¿ç”¨&lt;a href=&quot;https://developers.google.com/protocol-buffers/&quot;&gt;protobuf&lt;/a&gt;è¿›è¡Œæ•°æ®ç¼–ç ï¼Œï¼ŒåŸºäºHttp2åè®®ï¼Œæä¾›äº†å¾ˆå¤šä¼˜åŠ¿ï¼Œæ¯”å¦‚:åŒå‘çš„æ•°æ®æµï¼Œæµæ§åˆ¶ï¼ŒåŒ…å¤´å‹ç¼©ï¼Œå¤šè·¯å¤ç”¨ç­‰ï¼Œè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒgrpcå®˜ç½‘ã€‚&lt;/p&gt;

&lt;h3&gt;protobuf3&lt;/h3&gt;

&lt;p&gt;protobufæ˜¯Googleæä¾›çš„ä¸€ä¸ªè·¨è¯­è¨€çš„æ•°æ®ç¼–ç æœºåˆ¶ï¼Œæ”¯æŒå¤šç§è¯­è¨€ï¼Œåœ¨ç»“åˆRPCä½¿ç”¨æ—¶ï¼Œå¯ä»¥èŠ‚çœå¸¦å®½ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ï¼Œgrpcæä¾›äº†protobufçš„ç›¸åº”å·¥å…·ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨protoæ–‡ä»¶å®šä¹‰RPCæ¥å£ï¼Œçº¦å®šä¼ è¾“æ•°æ®æ ¼å¼ï¼Œé€šè¿‡ç”Ÿæˆå·¥å…·ç”Ÿæˆç›¸åº”è¯­è¨€çš„æºæ–‡ä»¶ã€‚&lt;/p&gt;

&lt;h3&gt;å®šä¹‰ä¸€ä¸ªæ–‡ä»¶ä¼ è¾“æœåŠ¡&lt;/h3&gt;

&lt;p&gt;ä»¥ä¸‹ä¸ºä¸€ä¸ªæ–‡ä»¶æœåŠ¡çš„protoæ–‡ä»¶å®šä¹‰, file.proto :&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;protocol&quot;&gt;syntax ï¼ &quot;proto3&quot;;

package filetransfer;

//rpcè°ƒç”¨å®šä¹‰
service FileServer {
  rpc GetFile(FileDescriptor) returns (stream FileContent) {}
}

message FileDescriptor {
  string filename = 1;
}

message FileContent {
  bytes content = 1;
  string md5sum = 2;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡å·¥å…·ç”Ÿæˆç›¸åº”è¯­è¨€æºä»£ç ï¼Œä»¥&lt;a href=&quot;http://golang.org&quot;&gt;golang&lt;/a&gt;ä¸ºä¾‹ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;protoc --go_out=plugins=grpc:. file.proto
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸‹æ˜¯æœåŠ¡ç«¯çš„ä»£ç å®ç°:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;go&quot;&gt;const (
  BUFSIZE = 1024
)

func (am *AgentManager) GetFile(fd *pb.FileDescriptor, stream pb.FileServer_GetFileServer) error {
  filename := fd.Filename

  //make sure file existed.
  fo, err := os.Open(filename)
  if err != nil {
    return ErrNoSuchFile
  }
  defer func() {
      if err := fo.Close(); err != nil {
        panic(err)
      }
  }()

  content := &amp;amp;pb.FileContent {
    Content: make([]byte, BUFSIZE),
    Md5Sum: caculateMd5(filename),
  }
  for {
    n, err := fo.Read(content.Content)
    if err != nil &amp;amp;&amp;amp; err != io.EOF {
      return ErrReadFile
    }
    if n == 0 {
      break
    }

    if err := stream.Send(content); err != nil {
      return err
    }
  }

  //indicate the end of stream.
  return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸‹æ˜¯Clientç«¯ä»£ç :&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;go&quot;&gt;
func ReadFile(filename string, conn pb.FileServerClient) error {
  stream, err := conn.GetFile(filename)
  if err != nil {
    panic(err)
  }

  outFd, err := os.Create(filename)
  if err != nil {
    panic(err)
  }
  defer func() {
      if err := outFd.Close(); err != nil {
        panic(err)
      }
  }()

  for {
    content, err := stream.Recv()
    if err == io.EOF {
      break
    }
    if err != nil {
      panic(err)
    }

    if err := outFd.Write(content.Content); err != nil {
      panic(err)
    }
  }

  return nil
}


func checkMd5(filename string, md5 string) bool {
  return caculateMd5(filename) == md5
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»£ç æœ‰éƒ¨åˆ†çœç•¥.&lt;/p&gt;

&lt;h3&gt;grpc stream&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;protobuf&quot;&gt;syntax = &quot;proto3&quot;;

package chatservice;

service chatservice {
  //åŒå‘çš„stream
  rpc chat(stream ChatMessage) returns (ChatMessage) {}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;grpcçš„streamå¯ä»¥æ˜¯åŒå‘çš„ä¹Ÿå¯ä»¥æ˜¯å•å‘çš„ï¼Œåœ¨é€šè¿‡protoæ–‡ä»¶å®šä¹‰æ—¶æŒ‡å®šï¼Œæ¯”å¦‚: ä¹Ÿå¯ä»¥å®ç°å¦‚Chatè¿™æ ·çš„æ¥å£ã€‚&lt;/p&gt;

&lt;h3&gt;å‚è€ƒé“¾æ¥&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://talks.golang.org/2015/gotham-grpc.slide#1&quot;&gt;go-grpc-slides&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://coreos.com/blog/gRPC-protobufs-swagger.html&quot;&gt;Rest &amp;amp; gRPC&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/etcdserver/etcdserverpb/rpc.proto&quot;&gt;etcdv3 API proto&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/gengo/grpc-gateway&quot;&gt;gRPC rest gateway&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</content>
 </entry>
 
 <entry>
   <title>openstack rpcå®ç°æºç åˆ†æ</title>
   <link href="http://wangtaox.github.io/2015/11/21/rpc.html"/>
   <updated>2015-11-21T00:00:00+08:00</updated>
   <id>http://wangtaox.github.io/2015/11/21/rpc</id>
   <content type="html">&lt;h3&gt;RabbitMQçš„æ¶ˆæ¯æ¨¡å‹&lt;/h3&gt;

&lt;h4&gt;RabbitMQ åŸºæœ¬æ¦‚å¿µ:&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;Producer: æ¶ˆæ¯ç”Ÿäº§è€…&lt;/li&gt;
&lt;li&gt;Consumer: æ¶ˆæ¯æ¶ˆè´¹è€…&lt;/li&gt;
&lt;li&gt;Exchange: æ¥å—æ¶ˆæ¯çš„è½½ä½“&lt;/li&gt;
&lt;li&gt;Message: RabbitMQä¸­çš„åŸºæœ¬æ¶ˆæ¯å•å…ƒ&lt;/li&gt;
&lt;li&gt;Queue: å­˜å‚¨å¹¶æ¥å—Exchangeåˆ†å‘çš„æ¶ˆæ¯, ç”¨äºConsumeræ¥å—æ¶ˆæ¯&lt;/li&gt;
&lt;li&gt;Routing Key: æ ‡è¯†Message, ç”¨äºExchangeåˆ†å‘æ¶ˆæ¯çš„ä¾æ®&lt;/li&gt;
&lt;li&gt;Binding: Queueä¸Exchangeç»‘å®š, å¯é€‰çš„binding keyå‚æ•°ç”¨äºæŒ‡å®šç‰¹å®šçš„æ¶ˆæ¯(ç›¸å½“äºæ¶ˆæ¯çš„routing key)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;åœ¨RabbitMQä¸­, æ¶ˆæ¯æ˜¯å‘é€ç»™&lt;code&gt;Exchange&lt;/code&gt;çš„, è€Œä¸æ˜¯&lt;code&gt;Queue&lt;/code&gt;, &lt;code&gt;Producer&lt;/code&gt;å°†å¸¦æœ‰&lt;code&gt;Routing Key&lt;/code&gt;çš„æ¶ˆæ¯å‘é€ç»™ç›¸åº”çš„
&lt;code&gt;Exchange&lt;/code&gt;å, æ•´ä¸ªæ¶ˆæ¯çš„å‘é€è¿‡ç¨‹å°±ç»“æŸäº†; æ¶ˆæ¯çš„æ¥æ”¶æ˜¯é€šè¿‡&lt;code&gt;Queue&lt;/code&gt;å®Œæˆçš„, &lt;code&gt;Consumer&lt;/code&gt;åœ¨RabbitMQä¸­å®šä¹‰
ä¸€ä¸ª&lt;code&gt;Queue&lt;/code&gt;, ä¸ç›¸åº”çš„&lt;code&gt;Exchange&lt;/code&gt;è¿›è¡Œ&lt;code&gt;Binding&lt;/code&gt;, åœ¨&lt;code&gt;Binding&lt;/code&gt;æ—¶å¯æŒ‡å®šæ„Ÿå…´è¶£çš„æ¶ˆæ¯, é€šè¿‡&lt;code&gt;binding key&lt;/code&gt;æ¥å®Œæˆ,è¿™
æ ·æ¶ˆæ¯å°±ä¼šè¢«&lt;code&gt;Exchange&lt;/code&gt;æ ¹æ®&lt;code&gt;binding key&lt;/code&gt;åˆ†å‘åˆ°ç›¸åº”çš„&lt;code&gt;Queue&lt;/code&gt;ä¸Š,  &lt;code&gt;Consumer&lt;/code&gt;æ¥å—&lt;code&gt;Queue&lt;/code&gt;çš„æ¶ˆæ¯å³å¯,
è¿™æ ·æ•´ä¸ªæ¶ˆæ¯çš„æ¥æ”¶å°±å®Œæˆäº†.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://www.rabbitmq.com/img/tutorials/python-three-overall.png&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å¦‚ä¸Šå›¾æ‰€ç¤º, &lt;code&gt;P&lt;/code&gt;ä»£è¡¨&lt;code&gt;Producer&lt;/code&gt;, &lt;code&gt;x&lt;/code&gt;ä»£è¡¨&lt;code&gt;Exchange&lt;/code&gt;, çº¢è‰²çš„ä»£è¡¨&lt;code&gt;Queue&lt;/code&gt;ä»¥åŠç›¸åº”çš„queue name, bindingè¡¨ç¤ºä¸Š
è¿°çš„&lt;code&gt;Binding&lt;/code&gt;è¿‡ç¨‹, &lt;code&gt;C&lt;/code&gt;ä»£è¡¨&lt;code&gt;Consumer&lt;/code&gt;.&lt;/p&gt;

&lt;h4&gt;RabbitMQä¸­çš„Exchange&lt;/h4&gt;

&lt;p&gt;Exchangeåœ¨RabbitMQä¸­ä¹Ÿæœ‰ç›¸åº”çš„åˆ†ç±»:&lt;code&gt;Direct&lt;/code&gt; &lt;code&gt;Fanout&lt;/code&gt; &lt;code&gt;Topic&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Exchangeçš„åˆ†ç±»æ˜¯ä¸ºäº†å®ç°ä¸åŒçš„é€šä¿¡æ¨¡å¼&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Fanout: æ¶ˆæ¯å°†åˆ†å‘ç»™æ‰€æœ‰ä¸&lt;code&gt;Exchange&lt;/code&gt;ç»‘å®šçš„&lt;code&gt;Queue&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Direct: æ¶ˆæ¯å°†é€šè¿‡ &lt;em&gt;å®Œå…¨åŒ¹é…&lt;/em&gt; &lt;code&gt;Routing Key&lt;/code&gt;åˆ†å‘åˆ°ç›¸åº”çš„&lt;code&gt;Queue&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Topic: æ¶ˆæ¯å°†é€šè¿‡ &lt;em&gt;æ­£åˆ™åŒ¹é…(æ”¯æŒç‰¹æ®Šå­—ç¬¦)&lt;/em&gt; &lt;code&gt;Routing Key&lt;/code&gt;åˆ†å‘åˆ°ç›¸åº”çš„&lt;code&gt;Queue&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;å› æ­¤, å½“ä½¿ç”¨&lt;code&gt;Fanout&lt;/code&gt;ç±»å‹çš„&lt;code&gt;Exchange&lt;/code&gt;, æ¶ˆæ¯å°†åˆ†å‘è‡³æ‰€æœ‰ä¸è¯¥&lt;code&gt;Exchange&lt;/code&gt;ç»‘å®šçš„&lt;code&gt;Queue&lt;/code&gt;ä¸Š, æ­¤æ—¶ä¸ä¼šåŒ¹é…&lt;code&gt;Routing Key&lt;/code&gt;,
å½“ä½¿ç”¨&lt;code&gt;Direct&lt;/code&gt;ç±»å‹çš„&lt;code&gt;Exchange&lt;/code&gt;, æ¶ˆæ¯å°†é€šè¿‡&lt;em&gt;å®Œå…¨åŒ¹é…&lt;/em&gt;(&lt;code&gt;Routing Key&lt;/code&gt;ä¸&lt;code&gt;Binding Key&lt;/code&gt;)è¢«åˆ†å‘è‡³ç›¸åº”çš„&lt;code&gt;Queue&lt;/code&gt;, åŒç†,
&lt;code&gt;Topic&lt;/code&gt;ç±»å‹çš„&lt;code&gt;Exchange&lt;/code&gt;ä¼šè¿›è¡Œ&lt;em&gt;æ­£åˆ™åŒ¹é…&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;å¦‚å›¾, &lt;code&gt;Direct Exchange&lt;/code&gt;ç±»å‹çš„æ¶ˆæ¯æ¨¡å‹:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://www.rabbitmq.com/img/tutorials/direct-exchange.png&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å¦‚å›¾, &lt;code&gt;Topic Exchange&lt;/code&gt;ç±»å‹çš„æ¶ˆæ¯æ¨¡å‹:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://www.rabbitmq.com/img/tutorials/python-five.png&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ä»ä¸¤ç§ç±»å‹çš„&lt;code&gt;Exchange&lt;/code&gt;å¯ä»¥çœ‹å‡º, åŒºåˆ«ä»…åœ¨äºåˆ†å‘æ¶ˆæ¯æ—¶å¯¹äº&lt;code&gt;Routing Key&lt;/code&gt;çš„åŒ¹é…æ–¹å¼, &lt;code&gt;Direct&lt;/code&gt;æ˜¯&lt;em&gt;å®Œå…¨åŒ¹é…&lt;/em&gt;&lt;code&gt;Queue&lt;/code&gt;çš„&lt;code&gt;Binding Key&lt;/code&gt;,
&lt;code&gt;Topic&lt;/code&gt;åˆ™æ˜¯ä½¿ç”¨&lt;em&gt;æ­£åˆ™åŒ¹é…&lt;/em&gt;.&lt;/p&gt;

&lt;h3&gt;Openstack RPC&lt;/h3&gt;

&lt;p&gt;åœ¨Openstackä¸­, ç»„ä»¶å†…çš„é€šä¿¡ä¸»è¦é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®Œæˆ, è¿™æ ·å¯ä»¥ä½¿æ•´ä¸ªç³»ç»Ÿä»¥æ¾è€¦åˆçš„æ–¹å¼è¿›è¡Œåä½œ, ä»¥RabbitMQä¸ºä¾‹,
Openstackå®ç°äº†ç»„ä»¶é—´çš„RPCè°ƒç”¨, ä¸»è¦åŒ…æ‹¬&lt;em&gt;åŒæ­¥&lt;/em&gt;å’Œ&lt;em&gt;å¼‚æ­¥&lt;/em&gt;ä¸¤ç§è°ƒç”¨æ–¹å¼:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;python&quot;&gt;    &quot;&quot;&quot;oslo/messaging/rpc/client.py&quot;&quot;&quot;
    class RPCClient(object):

        &quot;&quot;&quot;A class for invoking methods on remote servers.
        The RPCClient class is responsible for sending method invocations to remote
        servers via a messaging transport.

        A cast() invocation just sends the request and returns immediately. 
        A call() invocation waits for the server to send a return value.
        &quot;&quot;&quot;

        def cast(self, ctxt, method, **kwargs):
            &quot;&quot;&quot;Invoke a method and return immediately.
            &quot;&quot;&quot;
            self.prepare().cast(ctxt, method, **kwargs)
        def call(self, ctxt, method, **kwargs):
            &quot;&quot;&quot;Invoke a method and wait for a reply.
            &quot;&quot;&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ’å…¥çš„ä»£ç åªæ˜¯RPCClientå®ç°çš„ä¸€éƒ¨åˆ†, ä»æ³¨é‡Šå¯ä»¥çœ‹å‡º, &lt;code&gt;castå‡½æ•°&lt;/code&gt;å±äºå¼‚æ­¥è°ƒç”¨, &lt;code&gt;callå‡½æ•°&lt;/code&gt;å±äºåŒæ­¥è°ƒç”¨.&lt;/p&gt;

&lt;h4&gt;castå®ç°æ–¹å¼&lt;/h4&gt;

&lt;p&gt;&lt;img src=&quot;http://docs.openstack.org/developer/nova/_images/flow2.png&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;rpcè°ƒç”¨æ–¹ä¼šåˆå§‹åŒ–&lt;code&gt;Topic Publisher&lt;/code&gt;, å°†æ¶ˆæ¯ä»¥&lt;code&gt;Routing Key&lt;/code&gt;ä¸ºtopicå‘é€è‡³é…ç½®çš„&lt;code&gt;Exchange&lt;/code&gt;ä¸­&lt;/li&gt;
&lt;li&gt;&lt;p&gt;rpcæ¥æ”¶æ–¹ä¼šåˆå§‹åŒ–ä¸¤ä¸ª&lt;code&gt;Topic Cosumer&lt;/code&gt;, åˆ†åˆ«é€šè¿‡topicå’Œtopic.hostä¸º&lt;code&gt;binding key&lt;/code&gt;å°†&lt;code&gt;Queue&lt;/code&gt;ä¸&lt;code&gt;Exchange&lt;/code&gt;ç»‘å®š,
è¿™æ ·æ¥æ”¶æ–¹å°±å¯ä»¥æ¥æ”¶è¿™ä¸¤ç§ç±»å‹çš„rpc message&lt;/p&gt;

&lt;p&gt;  &lt;code&gt;topic&lt;/code&gt;å³ä¸ºæ¶ˆæ¯çš„&lt;code&gt;Routing Key&lt;/code&gt;, æ‰€ä»¥æ¥æ”¶æ–¹å¯ä»¥æ¥å—åˆ°è°ƒç”¨æ–¹çš„rpc message.&lt;br&gt;
  &lt;code&gt;topic.host&lt;/code&gt;ä¸ºç‰¹å®šçš„hostä¸Šçš„æ¥æ”¶æ–¹è·å–rpc messageçš„æ–¹å¼, ä¾‹å¦‚: l3-agent.host1(é€šçŸ¥host1ä¸Šçš„l3-agentè¿›è¡Œç›¸å…³rpcè°ƒç”¨)&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;h4&gt;callå®ç°æ–¹å¼&lt;/h4&gt;

&lt;p&gt;&lt;img src=&quot;http://docs.openstack.org/developer/nova/_images/flow1.png&quot; alt=&quot;img&quot; /&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;rpcè°ƒç”¨æ–¹åˆå§‹åŒ–&lt;code&gt;Topic Publisher&lt;/code&gt;ç”¨äºå‘é€rpc message, åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ª&lt;code&gt;Direct Consumer&lt;/code&gt;ç”¨äºæ¥æ”¶è¿”å›çš„rpcè°ƒç”¨ç»“æœ,
ä¸ºäº†ä¿è¯æ”¶åˆ°ç›¸åº”çš„rpcè°ƒç”¨çš„ç»“æœ, rpc messageä¸­ä¼šä¿å­˜ä¸€ä¸ªå”¯ä¸€æ ‡è¯†è¯¥æ¶ˆæ¯çš„messga id(UUIDç±»å‹), æ¶ˆæ¯ä»¥&lt;code&gt;Routing Key&lt;/code&gt;ä¸ºtopicå‘é€è‡³
&lt;code&gt;Exchange&lt;/code&gt;ä¸­&lt;/li&gt;
&lt;li&gt;rpcæ¥æ”¶æ–¹ä¼šåˆå§‹åŒ–ä¸¤ä¸ª&lt;code&gt;Topic Cosumer&lt;/code&gt;, åˆ†åˆ«é€šè¿‡topicå’Œtopic.hostä¸º&lt;code&gt;binding key&lt;/code&gt;å°†&lt;code&gt;Queue&lt;/code&gt;ä¸&lt;code&gt;Exchange&lt;/code&gt;ç»‘å®š, rpc
æ¥æ”¶æ–¹æ‰§è¡Œrpcè°ƒç”¨, å®Œæˆåé€šè¿‡&lt;code&gt;Direct Publisher&lt;/code&gt;å°†ç»“æœå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­, è¿”å›çš„æ‰§è¡Œç»“æœmessageçš„&lt;code&gt;Routing Key&lt;/code&gt;ä¸ºmessage id
(å”¯ä¸€çš„UUID), å°†è¢«å‘é€è‡³&lt;code&gt;Exchange&lt;/code&gt;(åç§°åŒæ ·æ˜¯å”¯ä¸€çš„message id), é‚£æ ·è°ƒç”¨æ–¹çš„&lt;code&gt;Direct Consumer&lt;/code&gt;å°±å¯ä»¥æ”¶åˆ°rpcè°ƒç”¨çš„ç»“æœäº†.&lt;/li&gt;
&lt;/ol&gt;


&lt;h4&gt;ä»¥ovs_neutron_agentä¸ºä¾‹ç†è§£rpcçš„å®ç°&lt;/h4&gt;

&lt;p&gt;åœ¨ovs_neutron_agentçš„ä»£ç ä¸­, rpcçš„åˆå§‹åŒ–å¦‚ä¸‹:
~~~python
    &quot;&quot;&quot;plugins/openvswitch/agent/ovs_neutron_agent.py&quot;&quot;&quot;
    def setup_rpc(self):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    ......
    #ä½œä¸ºrpcè°ƒç”¨æ–¹çš„åˆå§‹åŒ–
    self.plugin_rpc = OVSPluginApi(topics.PLUGIN)   #ä¸ml2 plginé€šä¿¡
    self.state_rpc = agent_rpc.PluginReportStateAPI(topics.PLUGIN)

    #ä½œä¸ºrpcæ¥æ”¶æ–¹çš„åˆå§‹åŒ–
    self.topic = topics.AGENT
    # Handle updates from service
    self.endpoints = [self]
    # Define the listening consumers for the agent
    consumers = [[topics.PORT, topics.UPDATE],
                 [topics.NETWORK, topics.DELETE],
                 [constants.TUNNEL, topics.UPDATE],
                 [topics.SECURITY_GROUP, topics.UPDATE],
                 [topics.DVR, topics.UPDATE]]
    if self.l2_pop:
        consumers.append([topics.L2POPULATION,
                          topics.UPDATE, cfg.CONF.host])
    self.connection = agent_rpc.create_consumers(self.endpoints,
                                                 self.topic,
                                                 consumers)
    ......
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
self.topicä¸ºovs_neutron_agentä¼šæ¥æ”¶çš„rpc messageçš„ç±»å‹å‰ç¼€, åœ¨topics.pyä¸­å®šä¹‰:
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;&quot;&quot;&quot;common/topics.py&quot;&quot;&quot;
AGENT = &#39;q-agent-notifier&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;åœ¨neutronä¸­, æ¶ˆæ¯å¯ä»¥åˆ†ä¸ºä¸åŒçš„ç±»å‹, ä»¥AGENT=&#39;q-agent-notifier&#39;ä¸ºä¾‹, è¡¨ç¤ºä¸ºé€šçŸ¥agentç«¯çš„æ¶ˆæ¯ç±»å‹.

self.consumersä¸ºovs_neutron_agentä¼šæ¥æ”¶çš„rpc messageçš„å…·ä½“ç±»å‹, åœ¨agent_rpc.create_consumers()å‡½æ•°ä¸­, å®Œæˆäº†consumersçš„åˆå§‹åŒ–:
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;&quot;&quot;&quot;agent/rpc.py&quot;&quot;&quot;
def create_consumers(endpoints, prefix, topic_details):
    &quot;&quot;&quot;
    :param endpoints: The list of endpoints to process the incoming messages.
    :param prefix: Common prefix for the plugin/agent message queues.
    :param topic_details: A list of topics. Each topic has a name, an
                          operation, and an optional host param keying the
                          subscription to topic.host for plugin calls.
    &quot;&quot;&quot;

    connection = n_rpc.create_connection(new=True)
    for details in topic_details:
        topic, operation, node_name = itertools.islice(
            itertools.chain(details, [None]), 3)

        topic_name = topics.get_topic_name(prefix, topic, operation)
        connection.create_consumer(topic_name, endpoints, fanout=True)
        if node_name: #node_nameå³ä¸ºhost name
            node_topic_name = &#39;%s.%s&#39; % (topic_name, node_name)
            connection.create_consumer(node_topic_name,
                                       endpoints,
                                       fanout=False)
    connection.consume_in_threads()
    return connection
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
è¿™é‡Œéœ€è¦å…³æ³¨çš„å°±æ˜¯create\_consumerå‡½æ•°, ä»¥åŠä¼ é€’ç»™è¯¥å‡½æ•°çš„å‚æ•°topic_name, endpoints, å¯¹äºfanoutå‚æ•°, å½“
hostå­˜åœ¨æ—¶, å°±ä¸éœ€è¦fanoutç±»å‹, å› ä¸ºåªéœ€è¦ç‰¹å®šçš„hostæ¥æ”¶. topic\_nameä¸ºprefix + topic + operation, ä¾‹å¦‚:
`q-agent-notifier-port-update`, `q-agent-notifier-port-update.hostname`, `q-agent-notifier-security_grout-update`ç­‰, 
è¿™äº›ä¾‹å­å°±ä¼šä½œä¸ºtopic_nameä¼ é€’ç»™create_consumerå‡½æ•°, endpointsä¸ºæ‰§è¡Œrpcå‡½æ•°çš„è½½ä½“, æ­¤å¤„åº”è¯¥ä¼ é€’çš„:
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;    self.endpoints = [self]  #ä¸Šé¢çš„setup_rpcå‡½æ•°ä¸­, å³ä¸ºå®ä¾‹æœ¬èº«
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;def get_server(target, endpoints, serializer=None):
    assert TRANSPORT is not None
    serializer = RequestContextSerializer(serializer)
    return messaging.get_rpc_server(TRANSPORT, target, endpoints,
                                    &#39;eventlet&#39;, serializer)

class Connection(object):

    def __init__(self):
        super(Connection, self).__init__()
        self.servers = []

    def create_consumer(self, topic, endpoints, fanout=False):
        target = messaging.Target(
            topic=topic, server=cfg.CONF.host, fanout=fanout)
        server = get_server(target, endpoints)
        self.servers.append(server)

    def consume_in_threads(self):
        for server in self.servers:
            server.start()
        return self.servers

# functions
def create_connection(new=True):
    return Connection()
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
åœ¨create_consumerå‡½æ•°ä¸­, é¦–å…ˆåˆå§‹åŒ–target, å…¶ä½œç”¨æ˜¯å°è£…äº†å…³äºrpc messageç›¸å…³è”çš„å±æ€§, 
æ¯”å¦‚è¯¥æ¶ˆæ¯å‘é€åˆ°çš„`Exchange`, æ¶ˆæ¯çš„topic(Routing Key)ç­‰.

&amp;gt; æ³¨æ„: åœ¨neutronä¸­, æ¶ˆæ¯çš„topicå…¶å®å°±æ˜¯æ¶ˆæ¯å‘é€è¿›`Exchange`æ‰€å¸¦æœ‰çš„`Routing Key`, æ¯”å¦‚ä»¥topic `q-agent-notifier-port-update`
&amp;gt; ä¸ºä¾‹, ä¸port-updateç›¸å…³çš„rpc messageåº”è¯¥éƒ½æ˜¯`Routing Key`ä¸º`q-agent-notifier-port-update`çš„.

ç„¶ååœ¨get_serverå‡½æ•°ä¸­, serializerä¸ºåºåˆ—åŒ–rpcæ¶ˆæ¯çš„å‡½æ•°, ç”¨äºå°†raw rpc messageåºåˆ—åŒ–ä¸ºé€‚åˆneutronä¸Šä¸‹æ–‡çš„dict, å¯ä»¥ä¸ç”¨
æ·±å…¥å»çœ‹, æ˜ç™½å…¶å«ä¹‰å³å¯, TRANSPORTä¸ºæ¶ˆæ¯çš„ä¼ é€’è½½ä½“, å› ä¸ºopenstackä¸­å¯ä»¥ä½¿ç”¨rabbitmq, ä»¥åŠzeromqç­‰æ¶ˆæ¯é˜Ÿåˆ—, TRANSPOSTä¸»è¦
å®Œæˆäº†å¯¹ç›¸åº”æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½çš„å°è£…, è¿™å„¿ä»¥rabbitmqä¸ºæ¶ˆæ¯é˜Ÿåˆ—, ä¹Ÿå°±æ˜¯è¯´, æ¶ˆæ¯æ˜¯é€šè¿‡TRANSPORT(rabbimq)ä¼ é€’çš„.
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;def get_rpc_server(transport, target, endpoints,
                   executor=&#39;blocking&#39;, serializer=None):
    &quot;&quot;&quot;Construct an RPC server.

    The executor parameter controls how incoming messages will be received and
    dispatched. By default, the most simple executor is used - the blocking
    executor.

    :param transport: the messaging transport
    :type transport: Transport
    :param target: the exchange, topic and server to listen on
    :type target: Target
    :param endpoints: a list of endpoint objects
    :type endpoints: list
    :param executor: name of a message executor - for example
                     &#39;eventlet&#39;, &#39;blocking&#39;
    :type executor: str
    :param serializer: an optional entity serializer
    :type serializer: Serializer
    &quot;&quot;&quot;
    dispatcher = rpc_dispatcher.RPCDispatcher(target, endpoints, serializer)
    return msg_server.MessageHandlingServer(transport, dispatcher, executor)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
åœ¨messaging.get_rpc_serverå‡½æ•°ä¸­, è¿›è¡Œäº†dispatcherçš„åˆå§‹åŒ–, å®ƒçš„ä¸»è¦ä½œç”¨ä¸ºä»TRANSPORTä¸­æ¥å—æ„Ÿå…´è¶£çš„æ¶ˆæ¯, 
è€Œtargetæè¿°äº†è¿™äº›æ„Ÿå…´è¶£çš„æ¶ˆæ¯çš„å±æ€§, targetè®°å½•äº†è¿™äº›ä¿¡æ¯.
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;class MessageHandlingServer(object):
    &quot;&quot;&quot;Server for handling messages.

    Connect a transport to a dispatcher that knows how to process the
    message using an executor that knows how the app wants to create
    new tasks.
    &quot;&quot;&quot;

    def __init__(self, transport, dispatcher, executor=&#39;blocking&#39;):
        &quot;&quot;&quot;Construct a message handling server.

        The dispatcher parameter is a callable which is invoked with context
        and message dictionaries each time a message is received.

        The executor parameter controls how incoming messages will be received
        and dispatched. By default, the most simple executor is used - the
        blocking executor.

        :param transport: the messaging transport
        :type transport: Transport
        :param dispatcher: a callable which is invoked for each method
        :type dispatcher: callable
        :param executor: name of message executor - for example
                         &#39;eventlet&#39;, &#39;blocking&#39;
        :type executor: str
        &quot;&quot;&quot;
        self.conf = transport.conf

        self.transport = transport
        self.dispatcher = dispatcher
        self.executor = executor

        try:
            mgr = driver.DriverManager(&#39;oslo.messaging.executors&#39;,
                                       self.executor)
        except RuntimeError as ex:
            raise ExecutorLoadFailure(self.executor, ex)
        else:
            self._executor_cls = mgr.driver
            self._executor = None

        super(MessageHandlingServer, self).__init__()

    def start(self):
        &quot;&quot;&quot;Start handling incoming messages.
        &quot;&quot;&quot;
        if self._executor is not None:
            return
        try:
            listener = self.dispatcher._listen(self.transport)
        except driver_base.TransportDriverError as ex:
            raise ServerListenError(self.target, ex)

        self._executor = self._executor_cls(self.conf, listener,
                                            self.dispatcher)
        self._executor.start()
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
æ¥ä¸‹æ¥åœ¨MessageHandlingServer(transport, dispatcher, executor)ä¸­, executorä¸º&#39;blocking&#39;, è¡¨ç¤ºrpcå‡½æ•°çš„æ‰§è¡Œä¼š
é˜»å¡å½“å‰çº¿ç¨‹, ç›¸åº”çš„å‚æ•°è¿˜æœ‰&#39;eventlet&#39;, è¡¨ç¤ºåœ¨æ–°çš„eventletçº¿ç¨‹ä¸­æ‰§è¡Œ, æˆ‘ä»¬ä¹Ÿä¸éœ€è¦å…³å¿ƒè¿™éƒ¨åˆ†å†…å®¹, ä½†æ˜¯
éœ€è¦æ˜ç™½å…¶ä½œç”¨. åœ¨ä¸Šé¢çš„startå‡½æ•°ä¸­, listenerä¸ºdispatcherçš„_listenæ‰€è¿”å›çš„ç»“æœ, ä»listenerä¸­, æˆ‘ä»¬å°±å¯ä»¥
æ¥æ”¶åˆ°ä¸€ä¸ªä¸€ä¸ªçš„æ¶ˆæ¯äº†, ç„¶åé€šè¿‡self._executor.start(), å¼€å§‹è·å–æ¶ˆæ¯å¹¶è¿›è¡Œç›¸åº”çš„rpcè°ƒç”¨.
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;def spawn_with(ctxt, pool):
    &quot;&quot;&quot;This is the equivalent of a with statement
    but with the content of the BLOCK statement executed
    into a greenthread

    exception path grab from:
    http://www.python.org/dev/peps/pep-0343/
    &quot;&quot;&quot;

    def complete(thread, exit):
        exc = True
        try:
            try:
                thread.wait()
            except Exception:
                exc = False
                if not exit(*sys.exc_info()):
                    raise
        finally:
            if exc:
                exit(None, None, None)

    callback = ctxt.__enter__()
    thread = pool.spawn(callback)
    thread.link(complete, ctxt.__exit__)

    return thread

class EventletExecutor(base.ExecutorBase):

    &quot;&quot;&quot;A message executor which integrates with eventlet.

    This is an executor which polls for incoming messages from a greenthread
    and dispatches each message in its own greenthread.

    The stop() method kills the message polling greenthread and the wait()
    method waits for all message dispatch greenthreads to complete.
    &quot;&quot;&quot;

    def __init__(self, conf, listener, dispatcher):
        super(EventletExecutor, self).__init__(conf, listener, dispatcher)
        self.conf.register_opts(_eventlet_opts)
        self._thread = None
        self._greenpool = greenpool.GreenPool(self.conf.rpc_thread_pool_size)
        self._running = False

    def start(self):
        if self._thread is not None:
            return

        @excutils.forever_retry_uncaught_exceptions
        def _executor_thread():
            try:
                while self._running:
                    incoming = self.listener.poll(timeout=base.POLL_TIMEOUT)
                    if incoming is not None:
                        spawn_with(ctxt=self.dispatcher(incoming),
                                   pool=self._greenpool)
            except greenlet.GreenletExit:
                return

        self._running = True
        self._thread = eventlet.spawn(_executor_thread)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
åœ¨self.\_executorçš„å®ç°ä¸­, startå‡½æ•°çš„self.listener.poll()å‡½æ•°ä¸æ–­è·å–rpcæ¶ˆæ¯, å¹¶å°†æ–°æ¶ˆæ¯åœ¨æ–°çš„eventlet threadä¸­æ‰§è¡Œ, å…¶ä¸­spwan_withä¸­ä¼šäº§ç”Ÿ
æ–°çš„thread, åŒæ—¶ä¼ é€’ç»™spwan\_withçš„å‚æ•°ä¸ºctxt=self.dispatcher(incoming), éœ€è¦ç‰¹åˆ«æ³¨æ„, å› ä¸ºdispatcherå®ç°äº†[\_\_call\_\_][1]æ–¹æ³•, ç”±äº
self.dispatcheræ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡, å› æ­¤ctxt=self.dispatcher(incoming)è¿™æ ·çš„è°ƒç”¨æ˜¯å¯è¡Œçš„.

ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹åœ¨dispatcherä¸­, æ¶ˆæ¯æ˜¯æ€æ ·å¾—åˆ°å¤„ç†çš„.
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;class RPCDispatcher(object):
    &quot;&quot;&quot;A message dispatcher which understands RPC messages.

    A MessageHandlingServer is constructed by passing a callable dispatcher
    which is invoked with context and message dictionaries each time a message
    is received.

    RPCDispatcher is one such dispatcher which understands the format of RPC
    messages. The dispatcher looks at the namespace, version and method values
    in the message and matches those against a list of available endpoints.

    Endpoints may have a target attribute describing the namespace and version
    of the methods exposed by that object. All public methods on an endpoint
    object are remotely invokable by clients.
    &quot;&quot;&quot;

    def __init__(self, target, endpoints, serializer):
        &quot;&quot;&quot;Construct a rpc server dispatcher.

        :param target: the exchange, topic and server to listen on
        :type target: Target
        &quot;&quot;&quot;

        self.endpoints = endpoints
        self.serializer = serializer or msg_serializer.NoOpSerializer()
        self._default_target = msg_target.Target()
        self._target = target

    def _listen(self, transport):
        return transport._listen(self._target)

    @staticmethod
    def _is_namespace(target, namespace):
        return namespace == target.namespace

    @staticmethod
    def _is_compatible(target, version):
        endpoint_version = target.version or &#39;1.0&#39;
        return utils.version_is_compatible(endpoint_version, version)

    def _do_dispatch(self, endpoint, method, ctxt, args):
        ctxt = self.serializer.deserialize_context(ctxt)
        new_args = dict()
        for argname, arg in six.iteritems(args):
            new_args[argname] = self.serializer.deserialize_entity(ctxt, arg)
        result = getattr(endpoint, method)(ctxt, **new_args)
        return self.serializer.serialize_entity(ctxt, result)

    @contextlib.contextmanager
    def __call__(self, incoming):
        incoming.acknowledge()
        yield lambda: self._dispatch_and_reply(incoming)

    def _dispatch_and_reply(self, incoming):
        try:
            incoming.reply(self._dispatch(incoming.ctxt,
                                          incoming.message))
        except ExpectedException as e:
            LOG.debug(u&#39;Expected exception during message handling (%s)&#39;,
                      e.exc_info[1])
            incoming.reply(failure=e.exc_info, log_failure=False)
        except Exception as e:
            # sys.exc_info() is deleted by LOG.exception().
            exc_info = sys.exc_info()
            LOG.error(_(&#39;Exception during message handling: %s&#39;), e,
                      exc_info=exc_info)
            incoming.reply(failure=exc_info)
            # NOTE(dhellmann): Remove circular object reference
            # between the current stack frame and the traceback in
            # exc_info.
            del exc_info

    def _dispatch(self, ctxt, message):
        &quot;&quot;&quot;Dispatch an RPC message to the appropriate endpoint method.

        :param ctxt: the request context
        :type ctxt: dict
        :param message: the message payload
        :type message: dict
        :raises: NoSuchMethod, UnsupportedVersion
        &quot;&quot;&quot;
        method = message.get(&#39;method&#39;)
        args = message.get(&#39;args&#39;, {})
        namespace = message.get(&#39;namespace&#39;)
        version = message.get(&#39;version&#39;, &#39;1.0&#39;)

        found_compatible = False
        for endpoint in self.endpoints:
            target = getattr(endpoint, &#39;target&#39;, None)
            if not target:
                target = self._default_target

            if not (self._is_namespace(target, namespace) and
                    self._is_compatible(target, version)):
                continue

            if hasattr(endpoint, method): #ä»endpointä¸­è·å–ç›¸åº”çš„rpc method
                localcontext.set_local_context(ctxt) #æ‰§è¡Œrpcè°ƒç”¨
                try:
                    return self._do_dispatch(endpoint, method, ctxt, args) #è¿”å›åºåˆ—åŒ–çš„ç»“æœ
                finally:
                    localcontext.clear_local_context()

            found_compatible = True

        if found_compatible:
            raise NoSuchMethod(method)
        else:
            raise UnsupportedVersion(version, method=method)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
åœ¨\_\_call\_\_æ–¹æ³•ä¸­, è¿”å›çš„[lambda][2]å³ä¸º: self._dispatch_and_reply(incoming), ç„¶åæ¶ˆæ¯ä¼šåœ¨\_dispatchå‡½æ•°ä¸­è¢«å¤„ç†å¹¶è¿”å›ç›¸åº”çš„
rpcè°ƒç”¨çš„ç»“æœ.

#### Transportå¦‚ä½•é€šè¿‡Targetè·å–ç›¸åº”çš„æ¶ˆæ¯
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;    def _listen(self, transport):
        return transport._listen(self._target)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
åœ¨ä¸Šé¢dispatcherçš„å®ç°ä¸­, å¯ä»¥çœ‹åˆ°_listenå‡½æ•°æ˜¯é€šè¿‡tranport.\_listenå®ç°çš„, å¹¶ç›¸åº”çš„ä¼ é€’äº†self._targetä½œä¸ºå‚æ•°.
å› æ­¤, æˆ‘ä»¬å¯ä»¥é€šè¿‡ç†è§£Transportçš„å®ç°æ¥ç†è§£openstack neutronä¸­topicçš„å«ä¹‰.
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;class Transport(object):
    &quot;&quot;&quot;A messaging transport.
    This is a mostly opaque handle for an underlying messaging transport
    driver.
    It has a single &#39;conf&#39; property which is the cfg.ConfigOpts instance used
    to construct the transport object.
    &quot;&quot;&quot;
    def __init__(self, driver):
        self.conf = driver.conf
        self._driver = driver

    def _send(self, target, ctxt, message, wait_for_reply=None, timeout=None,
              retry=None):
        if not target.topic:
            raise exceptions.InvalidTarget(&#39;A topic is required to send&#39;,
                                           target)
        return self._driver.send(target, ctxt, message,
                                 wait_for_reply=wait_for_reply,
                                 timeout=timeout, retry=retry)

    def _send_notification(self, target, ctxt, message, version, retry=None):
        if not target.topic:
            raise exceptions.InvalidTarget(&#39;A topic is required to send&#39;,
                                           target)
        self._driver.send_notification(target, ctxt, message, version,
                                       retry=retry)

    def _listen(self, target):
        if not (target.topic and target.server):
            raise exceptions.InvalidTarget(&#39;A server\&#39;s target must have &#39;
                                           &#39;topic and server names specified&#39;,
                                           target)
        return self._driver.listen(target) #ç›¸åº”çš„å®ç°åœ¨driverä¸­å®ç°
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;
å¯ä»¥çœ‹åˆ°, ä¸åŒçš„transportéƒ½å®ç°äº†listenå‡½æ•°, ä»¥rabbitmqçš„å®ç°ä¸ºä¾‹, driverä»£ç å¦‚ä¸‹:
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;class AMQPDriverBase(base.BaseDriver):

    def __init__(self, conf, url, connection_pool,
                 default_exchange=None, allowed_remote_exmods=None):
        super(AMQPDriverBase, self).__init__(conf, url, default_exchange,
                                             allowed_remote_exmods)

        self._default_exchange = default_exchange

        self._connection_pool = connection_pool

        self._reply_q_lock = threading.Lock()
        self._reply_q = None
        self._reply_q_conn = None
        self._waiter = None

    def _get_exchange(self, target):
        return target.exchange or self._default_exchange

    def _get_connection(self, pooled=True):
        return rpc_amqp.ConnectionContext(self._connection_pool,
                                          pooled=pooled)

    def _get_reply_q(self):
        with self._reply_q_lock:
            if self._reply_q is not None:
                return self._reply_q

            reply_q = &#39;reply_&#39; + uuid.uuid4().hex

            conn = self._get_connection(pooled=False)

            self._waiter = ReplyWaiter(self.conf, reply_q, conn,
                                       self._allowed_remote_exmods)

            self._reply_q = reply_q
            self._reply_q_conn = conn

        return self._reply_q

    def _send(self, target, ctxt, message,
              wait_for_reply=None, timeout=None,
              envelope=True, notify=False, retry=None):

        # FIXME(markmc): remove this temporary hack
        class Context(object):
            def __init__(self, d):
                self.d = d

            def to_dict(self):
                return self.d

        context = Context(ctxt)
        msg = message

        if wait_for_reply:
            msg_id = uuid.uuid4().hex
            msg.update({&#39;_msg_id&#39;: msg_id})
            LOG.debug(&#39;MSG_ID is %s&#39;, msg_id)
            msg.update({&#39;_reply_q&#39;: self._get_reply_q()})

        rpc_amqp._add_unique_id(msg)
        rpc_amqp.pack_context(msg, context)

        if envelope:
            msg = rpc_common.serialize_msg(msg)

        if wait_for_reply:
            self._waiter.listen(msg_id)

        try:
            with self._get_connection() as conn:
                if notify:
                    conn.notify_send(self._get_exchange(target),
                                     target.topic, msg, retry=retry)
                elif target.fanout:
                    conn.fanout_send(target.topic, msg, retry=retry)
                else:
                    topic = target.topic
                    if target.server:
                        topic = &#39;%s.%s&#39; % (target.topic, target.server)
                    conn.topic_send(exchange_name=self._get_exchange(target),
                                    topic=topic, msg=msg, timeout=timeout,
                                    retry=retry)

            if wait_for_reply:
                result = self._waiter.wait(msg_id, timeout)
                if isinstance(result, Exception):
                    raise result
                return result
        finally:
            if wait_for_reply:
                self._waiter.unlisten(msg_id)

    def send(self, target, ctxt, message, wait_for_reply=None, timeout=None,
             retry=None):
        return self._send(target, ctxt, message, wait_for_reply, timeout,
                          retry=retry)

    def send_notification(self, target, ctxt, message, version, retry=None):
        return self._send(target, ctxt, message,
                          envelope=(version == 2.0), notify=True, retry=retry)

    def listen(self, target):
        conn = self._get_connection(pooled=False)

        listener = AMQPListener(self, conn)

        conn.declare_topic_consumer(exchange_name=self._get_exchange(target), #å®šä¹‰Topic Consumer
                                    topic=target.topic,
                                    callback=listener)
        conn.declare_topic_consumer(exchange_name=self._get_exchange(target),
                                    topic=&#39;%s.%s&#39; % (target.topic,
                                                     target.server),
                                    callback=listener)
        conn.declare_fanout_consumer(target.topic, listener)

        return listener

    def listen_for_notifications(self, targets_and_priorities, pool):
        conn = self._get_connection(pooled=False)

        listener = AMQPListener(self, conn)
        for target, priority in targets_and_priorities:
            conn.declare_topic_consumer(
                exchange_name=self._get_exchange(target),
                topic=&#39;%s.%s&#39; % (target.topic, priority),
                callback=listener, queue_name=pool)
        return listener
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;~~~&lt;/p&gt;

&lt;p&gt;ä»ä¸Šé¢listençš„ä»£ç , å°±å›åˆ°äº†rpc callå’Œrpc castæ¨¡å‹, å®šä¹‰Topic Consumer, ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šåˆå§‹åŒ–3ä¸ª&lt;code&gt;Consumer&lt;/code&gt;å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;è¿™è¦ä»rpcæ–¹æ³•è°ƒç”¨çš„æ–¹å¼è¯´èµ·, rpc callå’Œ rpc castæœ‰ä¸¤ç§æ–¹å¼: topic + topic.host, rpc fanout_castæœ‰ä¸€ç§æ–¹å¼: fanout, æ‰€ä»¥å¯¹åº”çš„&lt;code&gt;Consumer&lt;/code&gt;
ä¹Ÿæœ‰3ç§, å› ä¸ºåœ¨æ¶ˆæ¯çš„æ¥æ”¶æ–¹çœ‹æ¥, æˆ‘ä¸éœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯ä»¥ä»€ä¹ˆæ–¹å¼ä¼ è¾“è¿‡æ¥çš„, æ— è®ºæ˜¯rpc call, æˆ–è€…rpc cast, æˆ–rpc fanout_cast, å¯¹äº
æ¶ˆæ¯æœ¬èº«æ‰æ˜¯å®ƒéœ€è¦å…³å¿ƒçš„, å› æ­¤å®ƒå¯ä»¥æ¥æ”¶ä¸‰ç§æ–¹å¼å‘é€è¿‡æ¥çš„æ¶ˆæ¯, æ‰€ä»¥ä¼šåˆå§‹åŒ–3ç§&lt;code&gt;Consumer&lt;/code&gt;.&lt;/p&gt;

&lt;h3&gt;æ€»ç»“&lt;/h3&gt;

&lt;p&gt;ç»“åˆRabbbitMQçš„åŸºæœ¬æ¦‚å¿µ, ä¸éš¾çœ‹å‡º, openstackä¸­ä¸rpcè°ƒç”¨ç›¸å…³çš„topic, å¯¹æ¶ˆæ¯å‘é€æ–¹(rpcè°ƒç”¨æ–¹)æ¥è¯´, å®ƒå°±æ˜¯
æ¶ˆæ¯çš„&lt;code&gt;Routing Key&lt;/code&gt;, å¯¹äºæ¶ˆæ¯æ¥æ”¶æ–¹(rpcæ¥å—æ–¹), å®ƒå°±æ˜¯åˆå§‹åŒ–&lt;code&gt;Consumer&lt;/code&gt;æ—¶ç”¨äºæ¥å—æ¶ˆæ¯çš„&lt;code&gt;Queue&lt;/code&gt;çš„åç§°,
ä¸”&lt;code&gt;Queue&lt;/code&gt;ä¸&lt;code&gt;Exchange&lt;/code&gt;çš„Binding Keyä¹Ÿä¸ºå®ƒ.&lt;/p&gt;

&lt;h3&gt;å‚è€ƒç½‘ç«™&lt;/h3&gt;

&lt;p&gt;RabbitMQ:   &lt;a href=&quot;http://www.rabbitmq.com/&quot;&gt;http://www.rabbitmq.com/&lt;/a&gt;&lt;/p&gt;
</content>
 </entry>
 
 
</feed>
